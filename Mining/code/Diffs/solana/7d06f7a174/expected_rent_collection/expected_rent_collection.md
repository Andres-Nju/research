File_Code/solana/7d06f7a174/expected_rent_collection/expected_rent_collection_after.rs --- Rust
 31 /*                                                                                                                                                        31 /*
 32 A goal is to skip rewrites to improve performance.                                                                                                        32 A goal is to skip rewrites to improve performance.
 33 Reasons this file exists:                                                                                                                                 33 Reasons this file exists:
 34 A. When we encounter skipped-rewrite account data as part of a load, we may need to update rent_epoch.                                                    34 A. When we encounter skipped-rewrite account data as part of a load, we may need to update rent_epoch.
 35 B. When we encounter skipped-rewrite account data during accounts hash calc, the saved hash will be incorrect if we skipped a rewrite.                    35 B. When we encounter skipped-rewrite account data during accounts hash calc, the saved hash will be incorrect if we skipped a rewrite.
 36      We need slot and rent_epoch to recalculate a new hash.                                                                                               36      We need slot and rent_epoch to recalculate a new hash.
 37                                                                                                                                                           37 
 38 cases of rent collection:                                                                                                                                 38 cases of rent collection:
 39                                                                                                                                                           39 
 40 setup assumptions:                                                                                                                                        40 setup assumptions:
 41 pubkey = abc                                                                                                                                              41 pubkey = abc
 42 slots_per_epoch = 432,000                                                                                                                                 42 slots_per_epoch = 432,000
 43 pubkey_partition_index of 'abc' = 80                                                                                                                      43 pubkey_partition_index of 'abc' = 80
 44                                                                                                                                                           44 
 45 So, rent will be collected or a rewrite is expected to occur:                                                                                             45 So, rent will be collected or a rewrite is expected to occur:
 46  each time a slot's pubkey_partition is == [footnote1] pubkey_partition_index within an epoch. [footnote2]                                                46  each time a slot's pubkey_partition is == [footnote1] pubkey_partition_index within an epoch. [footnote2]
 47                                                                                                                                                           47 
 48  If we skip rewrites, then pubkey's account data will not be rewritten when its rent collecion partition index occurs.                                    48  If we skip rewrites, then pubkey's account data will not be rewritten when its rent collection partition index occurs.
 49  However, later we need to get a hash value for the most recent update to this account.                                                                   49  However, later we need to get a hash value for the most recent update to this account.
 50  That leads us to the purpose of this file.                                                                                                               50  That leads us to the purpose of this file.
 51  To calculate a hash for account data, we need to know:                                                                                                   51  To calculate a hash for account data, we need to know:
 52    1. the slot the account was written in                                                                                                                 52    1. the slot the account was written in
 53    2. the rent_epoch field of the account, telling us which epoch is the next time we should evaluate rent on this account                                53    2. the rent_epoch field of the account, telling us which epoch is the next time we should evaluate rent on this account
 54  If we did not perform a rewrite, then the account in the append vec it was last written in has:                                                          54  If we did not perform a rewrite, then the account in the append vec it was last written in has:
 55    1. The wrong slot, since the append vec is not associated with the slot that the rewrite would have occurred.                                          55    1. The wrong slot, since the append vec is not associated with the slot that the rewrite would have occurred.
 56    2. The wrong rent_epoch since the account was not rewritten with a newer rent_epoch [footnote3]                                                        56    2. The wrong rent_epoch since the account was not rewritten with a newer rent_epoch [footnote3]
 57                                                                                                                                                           57 
 58 Reason A for this file's existence:                                                                                                                       58 Reason A for this file's existence:
 59 When we encounter the skipped-rewrite account data as part of a load, we may need to update rent_epoch.                                                   59 When we encounter the skipped-rewrite account data as part of a load, we may need to update rent_epoch.
 60 Many operations work like this:                                                                                                                           60 Many operations work like this:
 61   1. read account                                                                                                                                         61   1. read account
 62   2. add lamports (ex: reward was paid)                                                                                                                   62   2. add lamports (ex: reward was paid)
 63   3. write account                                                                                                                                        63   3. write account
 64 If the account is written with the WRONG rent_epoch field, then we will store an 'incorrect' rent_epoch field and the hash will be incorrect.             64 If the account is written with the WRONG rent_epoch field, then we will store an 'incorrect' rent_epoch field and the hash will be incorrect.
 65 So, at (1. read account), we must FIX the rent_epoch to be as it would be if the rewrite would have occurred.                                             65 So, at (1. read account), we must FIX the rent_epoch to be as it would be if the rewrite would have occurred.
 66                                                                                                                                                           66 
 67 Reason B for this file's existence:                                                                                                                       67 Reason B for this file's existence:
 68 When we encounter the skipped-rewrite account data during accounts hash calc, the saved hash will be incorrect if we skipped a rewrite.                   68 When we encounter the skipped-rewrite account data during accounts hash calc, the saved hash will be incorrect if we skipped a rewrite.
 69 We must compute the correct rent_epoch and slot and recompute the hash that we would have gotten if we would have done the rewrite.                       69 We must compute the correct rent_epoch and slot and recompute the hash that we would have gotten if we would have done the rewrite.
 70                                                                                                                                                           70 
 71 Both reasons result in the need for the same answer.                                                                                                      71 Both reasons result in the need for the same answer.
 72 Given                                                                                                                                                     72 Given
 73 1. pubkey                                                                                                                                                 73 1. pubkey
 74 2. pubkey's account data                                                                                                                                  74 2. pubkey's account data
 75 3. the slot the data was loaded from (storage_slot)                                                                                                       75 3. the slot the data was loaded from (storage_slot)
 76 4. the highest_root caller cares about                                                                                                                    76 4. the highest_root caller cares about
 77                                                                                                                                                           77 
 78 We also need a RentCollector and EpochSchedule for the highest root the caller cares about.                                                               78 We also need a RentCollector and EpochSchedule for the highest root the caller cares about.
 79 With these:                                                                                                                                               79 With these:
 80 1. can calculate partition_index of                                                                                                                       80 1. can calculate partition_index of
 81 1.a. highest_root (slot)                                                                                                                                  81 1.a. highest_root (slot)
 82 1.b. storage_slot                                                                                                                                         82 1.b. storage_slot
 83                                                                                                                                                           83 
 84 We also need :                                                                                                                                            84 We also need :
 85 fn find_unskipped_slot(slot) -> root                                                                                                                      85 fn find_unskipped_slot(slot) -> root
 86 which can return the lowest root >= slot - 1 (this is why 'historical_roots' is necessary) Also see [footnote1].                                          86 which can return the lowest root >= slot - 1 (this is why 'historical_roots' is necessary) Also see [footnote1].
 87                                                                                                                                                           87 
 88 Given these inputs, we can determine the correct slot and rent_epoch where we SHOULD have found this account's data and also compute the hash that we SH  88 Given these inputs, we can determine the correct slot and rent_epoch where we SHOULD have found this account's data and also compute the hash that we SH
 .. OULD have stored at that slot.                                                                                                                            .. OULD have stored at that slot.
 89 Note that a slot could be (-432k..infinite) slots and (-1..infinite) epochs relative to the expected rent collection slot.                                89 Note that a slot could be (-432k..infinite) slots and (-1..infinite) epochs relative to the expected rent collection slot.
 90 Examples:                                                                                                                                                 90 Examples:
 91 1.                                                                                                                                                        91 1.
 92 storage_slot: 1                                                                                                                                           92 storage_slot: 1
 93 highest_root: 1                                                                                                                                           93 highest_root: 1
 94 since pubkey_partition_index is 80 and hasn't been reached, the current account's data is CORRECT                                                         94 since pubkey_partition_index is 80 and hasn't been reached, the current account's data is CORRECT
 95 Every highest_root < 80 is this same result.                                                                                                              95 Every highest_root < 80 is this same result.
 96                                                                                                                                                           96 
 97 2.                                                                                                                                                        97 2.
 98 storage_slot: 1                                                                                                                                           98 storage_slot: 1
 99 highest_root: 79                                                                                                                                          99 highest_root: 79
100 since pubkey_partition_index is 80 and hasn't been reached, the current account's data is CORRECT                                                        100 since pubkey_partition_index is 80 and hasn't been reached, the current account's data is CORRECT
101                                                                                                                                                          101 
102 3.                                                                                                                                                       102 3.
103 storage_slot: 1  (partition index = 1)                                                                                                                   103 storage_slot: 1  (partition index = 1)
104 highest_root: 80 (partition index = 80)                                                                                                                  104 highest_root: 80 (partition index = 80)
105 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    105 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
106 the account's hash is incorrect and needs to be recalculated as of slot 80                                                                               106 the account's hash is incorrect and needs to be recalculated as of slot 80
107 rent_epoch will be 0                                                                                                                                     107 rent_epoch will be 0
108 Every highest_root >= 80 and < 432k + 80 is this same result                                                                                             108 Every highest_root >= 80 and < 432k + 80 is this same result
109                                                                                                                                                          109 
110 4.                                                                                                                                                       110 4.
111 storage_slot: 1  (partition index = 1)                                                                                                                   111 storage_slot: 1  (partition index = 1)
112 find_unskipped_slot(80) returns 81 since slot 80 was SKIPPED                                                                                             112 find_unskipped_slot(80) returns 81 since slot 80 was SKIPPED
113 highest_root: 81 (partition index = 81)                                                                                                                  113 highest_root: 81 (partition index = 81)
114 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    114 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
115 the account's hash is incorrect and needs to be recalculated as of slot 81 (note 81 because 80 was skipped)                                              115 the account's hash is incorrect and needs to be recalculated as of slot 81 (note 81 because 80 was skipped)
116 rent_epoch will be 0                                                                                                                                     116 rent_epoch will be 0
117 Every highest_root >= 80 and < 432k + 80 is this same result                                                                                             117 Every highest_root >= 80 and < 432k + 80 is this same result
118                                                                                                                                                          118 
119 5.                                                                                                                                                       119 5.
120 storage_slot:        1  (partition index = 1) (epoch 0)                                                                                                  120 storage_slot:        1  (partition index = 1) (epoch 0)
121 highest_root: 432k + 1  (partition index = 1) (epoch 1)                                                                                                  121 highest_root: 432k + 1  (partition index = 1) (epoch 1)
122 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    122 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
123 the account's hash is incorrect and needs to be recalculated as of slot 80 in epoch 0                                                                    123 the account's hash is incorrect and needs to be recalculated as of slot 80 in epoch 0
124 partition_index 80 has NOT been reached in epoch 1                                                                                                       124 partition_index 80 has NOT been reached in epoch 1
125 so, rent_epoch will be 0                                                                                                                                 125 so, rent_epoch will be 0
126 Every highest_root >= 80 and < 432k + 80 is this same result                                                                                             126 Every highest_root >= 80 and < 432k + 80 is this same result
127                                                                                                                                                          127 
128 6.                                                                                                                                                       128 6.
129 storage_slot:         1  (partition index =  1) (epoch 0)                                                                                                129 storage_slot:         1  (partition index =  1) (epoch 0)
130 highest_root: 432k + 80  (partition index = 80) (epoch 1)                                                                                                130 highest_root: 432k + 80  (partition index = 80) (epoch 1)
131 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    131 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
132 the account's hash is incorrect and needs to be recalculated as of slot 432k + 80 in epoch 1                                                             132 the account's hash is incorrect and needs to be recalculated as of slot 432k + 80 in epoch 1
133 partition_index 80 HAS been reached in epoch 1                                                                                                           133 partition_index 80 HAS been reached in epoch 1
134 so, rent_epoch will be 1                                                                                                                                 134 so, rent_epoch will be 1
135 Every highest_root >= 432k + 80 and < 432k * 2 + 80 is this same result                                                                                  135 Every highest_root >= 432k + 80 and < 432k * 2 + 80 is this same result
136                                                                                                                                                          136 
137 7.                                                                                                                                                       137 7.
138 storage_slot:         1  (partition index =  1) (epoch 0)                                                                                                138 storage_slot:         1  (partition index =  1) (epoch 0)
139 find_unskipped_slot(432k + 80) returns 432k + 81 since slot 432k + 80 was SKIPPED                                                                        139 find_unskipped_slot(432k + 80) returns 432k + 81 since slot 432k + 80 was SKIPPED
140 highest_root: 432k + 81  (partition index = 81) (epoch 1)                                                                                                140 highest_root: 432k + 81  (partition index = 81) (epoch 1)
141 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    141 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
142 the account's hash is incorrect and needs to be recalculated as of slot 432k + 81 in epoch 1 (slot 432k + 80 was skipped)                                142 the account's hash is incorrect and needs to be recalculated as of slot 432k + 81 in epoch 1 (slot 432k + 80 was skipped)
143 partition_index 80 HAS been reached in epoch 1                                                                                                           143 partition_index 80 HAS been reached in epoch 1
144 so, rent_epoch will be 1                                                                                                                                 144 so, rent_epoch will be 1
145 Every highest_root >= 432k + 81 and < 432k * 2 + 80 is this same result                                                                                  145 Every highest_root >= 432k + 81 and < 432k * 2 + 80 is this same result
146                                                                                                                                                          146 
147 8.                                                                                                                                                       147 8.
148 storage_slot:            1  (partition index = 1) (epoch 0)                                                                                              148 storage_slot:            1  (partition index = 1) (epoch 0)
149 highest_root: 432k * 2 + 1  (partition index = 1) (epoch 2)                                                                                              149 highest_root: 432k * 2 + 1  (partition index = 1) (epoch 2)
150 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    150 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
151 the account's hash is incorrect and needs to be recalculated as of slot 432k + 80 in epoch 1                                                             151 the account's hash is incorrect and needs to be recalculated as of slot 432k + 80 in epoch 1
152 partition_index 80 has NOT been reached in epoch 2                                                                                                       152 partition_index 80 has NOT been reached in epoch 2
153 so, rent_epoch will 1                                                                                                                                    153 so, rent_epoch will 1
154 Every highest_root >= 432k + 80 and < 432k * 2 + 80 is this same result                                                                                  154 Every highest_root >= 432k + 80 and < 432k * 2 + 80 is this same result
155                                                                                                                                                          155 
156 9.                                                                                                                                                       156 9.
157 storage_slot:             1  (partition index =  1) (epoch 0)                                                                                            157 storage_slot:             1  (partition index =  1) (epoch 0)
158 highest_root: 432k * 2 + 80  (partition index = 80) (epoch 2)                                                                                            158 highest_root: 432k * 2 + 80  (partition index = 80) (epoch 2)
159 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect                    159 since pubkey_partition_index is 80 and it HAS been reached, but the account data is from slot 1, then the account's data is INcorrect
160 the account's hash is incorrect and needs to be recalculated as of slot 432k * 2 + 80 in epoch 2                                                         160 the account's hash is incorrect and needs to be recalculated as of slot 432k * 2 + 80 in epoch 2
161 partition_index 80 HAS been reached in epoch 2                                                                                                           161 partition_index 80 HAS been reached in epoch 2
162 so, rent_epoch will be 2                                                                                                                                 162 so, rent_epoch will be 2
163 Every highest_root >= 432k * 2 + 80 and < 432k * 3 + 80 is this same result                                                                              163 Every highest_root >= 432k * 2 + 80 and < 432k * 3 + 80 is this same result
164                                                                                                                                                          164 
165 [footnote1:]                                                                                                                                             165 [footnote1:]
166   "each time a slot's pubkey_partition is == [footnote1] pubkey_partition_index within an epoch."                                                        166   "each time a slot's pubkey_partition is == [footnote1] pubkey_partition_index within an epoch."
167   Due to skipped slots, this is not true.                                                                                                                167   Due to skipped slots, this is not true.
168   In reality, it is:                                                                                                                                     168   In reality, it is:
169     the first slot where a slot's pubkey_partition >= pubkey_partition_index - 1.                                                                        169     the first slot where a slot's pubkey_partition >= pubkey_partition_index - 1.
170   So, simply, if the pubkey_partition for our rent is 80, then that slot occurs at these slot #s:                                                        170   So, simply, if the pubkey_partition for our rent is 80, then that slot occurs at these slot #s:
171     Slot:...........     Epoch:                                                                                                                          171     Slot:...........     Epoch:
172     0           + 80 for epoch 0                                                                                                                         172     0           + 80 for epoch 0
173     432,000     + 80 for epoch 1                                                                                                                         173     432,000     + 80 for epoch 1
174     432,000 * 2 + 80 for epoch 2                                                                                                                         174     432,000 * 2 + 80 for epoch 2
175     ...                                                                                                                                                  175     ...
176   However, sometimes we skip slots. So, just considering epoch 0:                                                                                        176   However, sometimes we skip slots. So, just considering epoch 0:
177     Normal, not skipping any slots:                                                                                                                      177     Normal, not skipping any slots:
178       slot 78 is a root                                                                                                                                  178       slot 78 is a root
179       slot 79 is a root                                                                                                                                  179       slot 79 is a root
180       slot 80 is a root (account is rewritten/rent collected here)                                                                                       180       slot 80 is a root (account is rewritten/rent collected here)
181     Scenario 1:                                                                                                                                          181     Scenario 1:
182       slot 78 is a root                                                                                                                                  182       slot 78 is a root
183       slot 79 is skipped/not a root                                                                                                                      183       slot 79 is skipped/not a root
184       slot 80 is a root (account is rewritten/rent collected here along with accounts from slot 79)                                                      184       slot 80 is a root (account is rewritten/rent collected here along with accounts from slot 79)
185     Scenario 2:                                                                                                                                          185     Scenario 2:
186       slot 78 is a root                                                                                                                                  186       slot 78 is a root
187       slot 79 is skipped/not a root                                                                                                                      187       slot 79 is skipped/not a root
188       slot 80 is skipped/not a root                                                                                                                      188       slot 80 is skipped/not a root
189       slot 81 is a root (account is rewritten/rent collected here because of slot 80, along with accounts from slots 79 and 81)                          189       slot 81 is a root (account is rewritten/rent collected here because of slot 80, along with accounts from slots 79 and 81)
190     This gets us to looking for:                                                                                                                         190     This gets us to looking for:
191       the first slot where a slot's pubkey_partition >= pubkey_partition_index - 1.                                                                      191       the first slot where a slot's pubkey_partition >= pubkey_partition_index - 1.
192                                                                                                                                                          192 
193 [footnote2:]                                                                                                                                             193 [footnote2:]
194   Describing partition_index within an epoch:                                                                                                            194   Describing partition_index within an epoch:
195   example:                                                                                                                                               195   example:
196     slot=0       is epoch=0, partition_index=0                                                                                                           196     slot=0       is epoch=0, partition_index=0
197     slot=1       is epoch=0, partition_index=1                                                                                                           197     slot=1       is epoch=0, partition_index=1
198     slot=431,999 is epoch=0, partition_index=431,999                                                                                                     198     slot=431,999 is epoch=0, partition_index=431,999
199     slot=432,000 is epoch=1, partition_index=432,000                                                                                                     199     slot=432,000 is epoch=1, partition_index=432,000
200     This is NOT technically accurate because of first_normal_slot, but we'll ignore that.                                                                200     This is NOT technically accurate because of first_normal_slot, but we'll ignore that.
201     EpochSchedule::get_epoch_and_slot_index(slot) calculates epoch and partition_index from slot.                                                        201     EpochSchedule::get_epoch_and_slot_index(slot) calculates epoch and partition_index from slot.
202                                                                                                                                                          202 
203 [footnote3:]                                                                                                                                             203 [footnote3:]
204   when we do a rewrite of account data, only this data changes:                                                                                          204   when we do a rewrite of account data, only this data changes:
205   1. rent_epoch                                                                                                                                          205   1. rent_epoch
206   2. computed hash value (which is a function of (data, lamports, executable, owner, rent_epoch, pubkey) + slot                                          206   2. computed hash value (which is a function of (data, lamports, executable, owner, rent_epoch, pubkey) + slot
207   3. into a new append vec that is associated with the slot#                                                                                             207   3. into a new append vec that is associated with the slot#
208                                                                                                                                                          208 
209 */                                                                                                                                                       209 */

